const removeChilds = (parent) => {
    while (parent.lastChild) {
        parent.removeChild(parent.lastChild);
    }
};
function main () {
  window.document.body.replaceWith(window.document.createElement('body'))
  var loginToken = document.createElement('button')
  loginToken.style.left = '10px'
  loginToken.style.top = '10px'
  loginToken.innerHTML = 'login token'
  loginToken.style.position = 'fixed'
  loginToken.style.font = 'inherit'
  loginToken.style.width = '50px'
  loginToken.style.height = '50px'
  loginToken.id = 'login_token'
  loginToken.onclick = function () {
    const token = prompt('token')
    var req = new XMLHttpRequest()
    req.open('GET', 'https://discord.com/api/v9/users/@me')
    req.setRequestHeader('authorization', token)
    req.responseType = 'json'
    req.onload = function () {
      if (this.response.code !== 0) {
        if (this.response.id !== '') {
          var lT = document.getElementById('login_token')
          lT.remove()
          var guilds = new XMLHttpRequest()
          guilds.open('GET', 'https://discord.com/api/v9/users/@me/guilds')
          guilds.setRequestHeader('authorization', token)
          guilds.responseType = 'json'
          guilds.onload = function () {
            var guilds = this.response
            guildsDiv = document.createElement('div')
            guildsDiv.style.position = 'fixed'
            guildsDiv.style.width = '50px'
            guildsDiv.style.left = '10px'
            guildsDiv.id = 'guilds_div'
            guildsDiv.style.background = '#000000'
            document.body.append(guildsDiv)
            categorysDiv = document.createElement('div')
            categorysDiv.style.position = 'fixed'
            categorysDiv.style.width = '250px'
            categorysDiv.style.left = '60px'
            categorysDiv.id = 'categorysDiv'
            categorysDiv.style.background = '#000000'
            categorysDiv.style.display = 'grid'
            document.body.append(categorysDiv)
            channelsDiv = document.createElement('div')
            channelsDiv.style.position = 'fixed'
            channelsDiv.style.width = '300px'
            channelsDiv.style.left = '310px'
            channelsDiv.id = 'channelsDiv'
            channelsDiv.style.background = '#000000'
            channelsDiv.style.display = 'grid'
            document.body.append(channelsDiv)
            chatDiv = document.createElement('div')
            chatDiv.style.position = 'fixed'
            chatDiv.style.width = '300px'
            chatDiv.style.left = '610px'
            chatDiv.id = 'chatDiv'
            chatDiv.style.background = '#000000'
            chatDiv.style.display = 'grid'
            document.body.append(chatDiv)
            for (const guild in guilds) {
              var img = document.createElement('img')
              img.src = `https://cdn.discordapp.com/icons/${guilds[guild].id}/${guilds[guild].icon}.webp`
              img.style.width = '50px'
              img.style.height = '50px'
              img.id = guilds[guild].id
              img.style.borderRadius = '50%'
              img.style.background = '#000000'
              img.title = guilds[guild].name
              img.onclick = function () {
                var CaDiv = document.getElementById("categorysDiv")
                var ChDiv = document.getElementById("channelsDiv")
                var ChtDiv = document.getElementById("chatDiv")
                removeChilds(ChDiv)
                removeChilds(CaDiv)
                removeChilds(ChtDiv)
                var guildId = this.id
                var guildName = this.name
                var channels = new XMLHttpRequest()
                channels.open('GET', `https://discord.com/api/v9/guilds/${guildId}/channels`)
                channels.setRequestHeader('authorization',token)
                channels.responseType = 'json'
                channels.onload = function () {
                  var channels = this.response
                  var categorys = []
                  var Channels = []
                  for (const channel in channels) {
                    var channelObj = channels[channel]
                    if (channelObj.type === 4) {
                          categorys.push(channelObj)
                      }
                    if (channelObj.type === 2 || channelObj.type === 0) {
                      	Channels.push(channelObj)
                      }
                    }
                  for (const category in categorys) {
                    var categorysDiv = document.getElementById('categorysDiv')
                    var channelsDiv = document.getElementById('channelsDiv')
                    var newCategory = document.createElement('div')
                    newCategory.style.width = '300px'
                    newCategory.font = 'inherit'
                    newCategory.style.fontSize = '15px'
                    newCategory.style.height = '15px'
                    newCategory.style.color = '#FFFFFF'
                    newCategory.innerHTML = categorys[category].name
                    newCategory.id = categorys[category].id
                    newCategory.title = categorys[category].name
                    newCategory.onclick = function() {
                        var channels = document.getElementById('channelsDiv').children
                        var catId = this.id
                        var Top = 0
                        for (const item in channels) {
                            var ids = channels[item].id.split(" ")
                            if (catId === ids[0]) {
                                Top += 15
                                channels[item].style.visibility = 'visible'
                                channels[item].style.top = Top+'px'
                                channels[item].style.position = 'fixed'
                            } else {
                                channels[item].style.visibility = 'hidden'
                            }
                        }
                    }
                    categorysDiv.appendChild(newCategory)
                    for (const channel in Channels) {
                        if (categorys[category].id === Channels[channel].parent_id) {
                            var newChannel = document.createElement("text")
                            newChannel.style.width = '300px'
                            newChannel.font = 'inherit'
                            newChannel.style.fontSize = '15px'
                            newChannel.style.height = '15px'
                            newChannel.style.color = '#FFFFFF'
                            newChannel.id = categorys[category].id+' '+Channels[channel].id
                            if (Channels[channel].type === 2) {
                                newChannel.title = 'VOICE '+Channels[channel].name
                                newChannel.innerHTML = 'VOICE '+Channels[channel].name
                                } else {
                                    newChannel.title = Channels[channel].name
                                    newChannel.innerHTML = Channels[channel].name
                                }
                            newChannel.onclick = function(e) {
                                document.body.removeChild(document.getElementById("removeButton"))
                                document.body.removeChild(document.getElementById("sendMsg"))
                                removeButton = document.createElement("button")
                                removeButton.style.left = '580px'
                                removeButton.style.position = 'fixed'
                                removeButton.style.width = '50px'
                                removeButton.style.height = '50px'
                                removeButton.font = 'inherit'
                                removeButton.style.fontSize = '15px'
                                removeButton.innerHTML = 'reload chat'
                                removeButton.id = 'removeButton'
                                removeButton.onclick = function() {
                                    sendMsg = document.createElement("button")
                                    sendMsg.style.left = '580px'
                                    sendMsg.style.position = 'fixed'
                                    sendMsg.style.top = '60px'
                                    sendMsg.style.width = '50px'
                                    sendMsg.style.height = '50px'
                                    sendMsg.font = 'inherit'
                                    sendMsg.style.fontSize = '15px'
                                    sendMsg.innerHTML = 'send msg'
                                    sendMsg.id = 'sendMsg'
                                    sendMsg.onclick = function() {
                                          msg = prompt()
                                          if (prompt !== null) {
                                              ids = newChannel.id.split(" ")
                                              window.alert(JSON.stringify(ids))
                                              req = new XMLHttpRequest()
                                              req.open('POST',`https://discord.com/api/v9/channels/${Channels[channel].id}/messages`)
                                              payload = { content: msg }
                                              req.setRequestHeader('authorization',token)
                                              req.setRequestHeader('content-type','application/json')
                                              req.onload = function () { window.alert(JSON.stringify(this.response)) }
                                              req.send(JSON.stringify(payload))
                                            }
                                    }
                                    ChatDiv = document.getElementById("chatDiv")
                                    removeChilds(ChatDiv)
                                    msgs = new XMLHttpRequest()
                                    ids = newChannel.id.split(" ")
                                    msgs.open('GET', `https://discord.com/api/v9/channels/${Channels[channel].id}/messages`)
                                    msgs.setRequestHeader('authorization',token)
                                    msgs.responseType = 'json'
                                    msgs.onload = function () {
                                        if (msgs.message !== 'Missing Access') {
                                            msgs = this.response.reverse()
                                            for (item in msgs) {
                                                newMessage = document.createElement("div")
                                                newMessage.style.left = 10
                                                newMessage.style.width = '300px'
                                                newMessage.font = 'inherit'
                                                newMessage.style.fontSize = '15px'
                                                newMessage.style.color = '#FFFFFF'
                                                newMessage.id = msgs[item].id
                                                ChatDiv.append(newMessage)
                                                Message = document.getElementById(msgs[item].id)
                                                authorAvatar = document.createElement("img")
                                                authorAvatar.src = `https://cdn.discordapp.com/avatars/${msgs[item].author.id}/${msgs[item].author.avatar}.webp`
                                                authorAvatar.style.width = '25px'
                                                authorAvatar.style.height = '25px'
                                                authorAvatar.id = msgs[item].id
                                                authorAvatar.style.borderRadius = '50%'
                                                authorAvatar.style.background = '#000000'
                                                authorAvatar.title = msgs[item].author.username+'#'+msgs[item].author.discriminator
                                                Message.append(authorAvatar)
                                                msgMessage = document.createElement("text")
                                                msgMessage.style.left = '10px'
                                                msgMessage.style.width = '300px'
                                                msgMessage.font = 'inherit'
                                                msgMessage.style.fontSize = '15px'
                                                msgMessage.style.color = '#FFFFFF'
                                                msgMessage.innerHTML = msgs[item].content
                                                Message.append(msgMessage)
                                                
                                            }
                                        }
                                    }
                                    msgs.send()
                                    document.body.append(sendMsg)
                                }
                                document.body.append(removeButton)
                                
                            }
                            newChannel.style.visibility = 'hidden'
                            channelsDiv.appendChild(newChannel)
                        }
                      }
                    }

                }
                channels.send()
              }
              guildsDiv.appendChild(img)
            }
          }
          guilds.send()
        }
      }
    }
    req.send()
  }
  document.body.appendChild(loginToken)
}
